# Лабораторная работа №14 IPsec
## Схема сети
![map](https://github.com/MIranaNightshade/otus-networks/blob/main/lab14_ipsec/jpeg/IPSEC_MAP.png)

### Задачи:
1. [Настроить GRE поверх IPSec между офисами Москва и С.-Петербург.](#1)
2. [Настроить DMVPN поверх IPSec между Москва и Чокурдах, Лабытнанги.](#2)
3. [Все узлы в офисах в лабораторной работе должны иметь IP связность.](#3)
*Для IPSec использовать CA и сертификаты.*

*Настроим СA на R14 и получим от него сертификаты на R14, R15, R18, R27, R28.*
Настраиваем по следующему шаблону:

**Сервер (R12):**
*Зададим хостнейм и домен, включим http server, чтобы другие роутры могли обращаться к R12 за сертификатами:*
hostname R12-CA
ip domain name otus.local
ip http server
*Сгенерируем пару ключей:*
crypto key generate rsa general-keys label R12-CA modulus 2048 exportable
*Включим CA сервер:*
crypto pki server R12-CA
  database level com
  no shut

**Клиенты:**
*Зададим домен:*
ip domain name otus.local

*укажем ip адрес нашего CA:*
ip host R12-CA 100.30.0.12

*Сгенерируем ключи:*
crypto key generate rsa

*Укажем куда роутеру обращаться за сертификатом:*
crypto pki trustpoint R12-CA
enrollment url http://R12-CA:80

**Получение клиентом сертификата сервера:**
crypto pki authenticate R12-CA

**Получение клиентом сертификата для себя:**
crypto pki enroll R12-CA

**Подтверждение всех сертификатов на сервере:**
crypto pki server R12-CA grant all


**Конфигурация на R12:**
```
!
hostname R12-CA
!
ip domain name otus.local
!
multilink bundle-name authenticated
!
!
!
!
!
!
!
crypto pki server R12-CA
 database level complete
 no database archive
!
crypto pki trustpoint R12-CA
 revocation-check crl
 rsakeypair R12-CA
!
!
crypto pki certificate chain R12-CA
 certificate ca 01
  30820300 308201E8 A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  11310F30 0D060355 04031306 5231322D 4341301E 170D3235 30383231 31343435
  33335A17 0D323830 38323031 34343533 335A3011 310F300D 06035504 03130652
  31322D43 41308201 22300D06 092A8648 86F70D01 01010500 0382010F 00308201
  0A028201 0100E2DB 1DA5CB72 409715B5 5D0E7D47 50F8E831 9F913A7D 49FB80C8
  08F58DAA 9479A54D 9D61FC40 D776EDD2 FCC40349 DFD93C26 00DADC81 0C6D9C25
  87A8EABE 3D417E60 0CFE8EBA F26697E1 3344B20C B40299FD 995D5F59 4DAAE35B
  0124FD3A 774E07FF 803CA040 84697378 9CDB6914 C825934D 8A1FC20B 486F14EA
  36D8536F 8D312F3D 6CBCA720 A311CC28 D5D86432 249392DC 19DC79CD BBA557EA
  08C21C5D 6DE5D0E5 828417B2 E56BA767 C6DD1220 1E7AE015 ABB8EFD4 0386FA04
  849EB165 FD06D670 68C6A08E 49E3A814 CD7267D5 140CCA4D C23A7676 249B8B73
  2A2F8550 0C466DFD BD855B05 99232D8F C077020E FC131BDF 58DB0150 1F653682
  CA7B8BDD C6F30203 010001A3 63306130 0F060355 1D130101 FF040530 030101FF
  300E0603 551D0F01 01FF0404 03020186 301F0603 551D2304 18301680 14898D10
  9B989422 A4FE365A 30E9748C 89F85168 51301D06 03551D0E 04160414 898D109B
  989422A4 FE365A30 E9748C89 F8516851 300D0609 2A864886 F70D0101 04050003
  82010100 CC6A378D BB1482E4 1A5C2580 7447D072 C02F00F3 2C5CC225 A200BA97
  53E26940 BA9963BA 7A2DDBB6 DBFE335C 6A49D003 5FBE6CD2 9D902284 6286CE28
  150F390D 6CEE3994 AF5FA171 91947024 6E514ADB DA5BC9BE B95046F9 55248FCD
  153FAFB8 68147911 2D4814F6 1BFFFA60 7C1C96D8 15E6A77A 7D68181D 5AF4DB72
  3B3E22C2 2BED9F40 F13CE120 F336C06C 6F9A5595 CB05A960 551FF031 946C94FA
  0CCF6CD4 AB85F01C 919E7282 8AB5B73C A1A54C9B BDC38903 76A96215 0678C5C4
  94AA2402 97D20660 DEBA15D0 4D0B61EA F64C96A6 4CBB92D3 FB351498 3C3B0EF0
  18A2CF0A B84267D6 EE2D0B01 CCF51190 C375BAB9 4038FE71 65F0BC9C A3F9D5FF 19D16F
14
        quit
!
redundancy
!
ip http server
```
**Пример конфигурации на клиенте (R27):**

```
!
hostname R27
!
ip domain name otus.local
ip host R12-CA 100.30.0.12
!
crypto pki trustpoint R12-CA
 enrollment url http://R12-CA:80
 serial-number
 revocation-check crl
!
!
crypto pki certificate chain R12-CA
 certificate 04
  3082030B 308201F3 A0030201 02020104 300D0609 2A864886 F70D0101 05050030
  11310F30 0D060355 04031306 5231322D 4341301E 170D3235 30383231 31343532
  33325A17 0D323630 38323131 34353233 325A3030 312E300F 06035504 05130836
  37313039 32393630 1B06092A 864886F7 0D010902 160E5232 372E6F74 75732E6C
  6F63616C 30820122 300D0609 2A864886 F70D0101 01050003 82010F00 3082010A
  02820101 00992FFA 01D30217 A5C9F150 45F1833C C1A24847 557B3DC3 76B0B62B
  E0BA22DB 4143247C B545EE1A C83CC07A C0771502 D2C52BCE C3417D88 F4B51BBD
  6FF3942D E3BB413A F09C4074 B4369896 C43D0DCB ADFA3E7B A9928812 3C1DB061
  7666B597 0982B462 8468C5F3 06B08EC4 44FCDDB0 230DF62B A937DBF8 205D6387
  ED8DA24A 4F5CAD0C CEFE19C4 7ECE4EE0 F17E0A85 A2C9417E 3A1885D7 BAFB5FA9
  E4EACB9C 09D88900 3C26FE59 BA48BB0F EF5DF493 0FD9708B 12183DEB 09F69B1D
  2170BCEA BAB254F1 C24F8AC6 E0E6F0B1 D93A1523 B86E9809 0B537F08 2BDA302E
  D47AEDC0 1481A96A BCFB4CF2 412B1D97 207E4952 F18D04F0 3C2BE603 D8A0E868
  7EDE35C1 43020301 0001A34F 304D300B 0603551D 0F040403 0205A030 1F060355
  1D230418 30168014 898D109B 989422A4 FE365A30 E9748C89 F8516851 301D0603
  551D0E04 160414AB 6CFC9A9B 455E0593 35317262 1E558690 E5FC3130 0D06092A
  864886F7 0D010105 05000382 0101000E B4DC1827 B127FAEA E6B632F7 FFAABD37
  EEDF3C6F 3F958138 653013F5 3253464F FB24928B 358D9EBA C226677E 20E94723
  BDC1FB5E 1AA8F5B8 26ECF0B6 C5928C18 227A35C1 41C31675 7542E2E0 50D6562C
  30BE290C 06DACB54 A7E42EB8 6D2596A9 30C260A3 3B8264B0 DDD39764 44A5B0A3
  A91819BE E7DBBF31 436214A9 E3571A7D 5D8212C7 935E96E3 C1F3A3BE F6043095
  BC5098FA 9C5DBC3D C501315C 1F14EF28 6F06B520 A943B4FB 11097B41 62F22E9F
  379752D7 BA6FD471 209FD3E2 3A39A2DA BF3DF8C3 869FDAD7 7B016892 62588CD3
  C3235414 CFBF5544 C1F00CAF FFFA252F 622836A0 2742974E 0642C576 76941EDA
  DE816BC1 539EEA05 50BC511B C42BCA
        quit
 certificate ca 01
  30820300 308201E8 A0030201 02020101 300D0609 2A864886 F70D0101 04050030
  11310F30 0D060355 04031306 5231322D 4341301E 170D3235 30383231 31343435
  33335A17 0D323830 38323031 34343533 335A3011 310F300D 06035504 03130652
  31322D43 41308201 22300D06 092A8648 86F70D01 01010500 0382010F 00308201
  0A028201 0100E2DB 1DA5CB72 409715B5 5D0E7D47 50F8E831 9F913A7D 49FB80C8
  08F58DAA 9479A54D 9D61FC40 D776EDD2 FCC40349 DFD93C26 00DADC81 0C6D9C25
  87A8EABE 3D417E60 0CFE8EBA F26697E1 3344B20C B40299FD 995D5F59 4DAAE35B
  0124FD3A 774E07FF 803CA040 84697378 9CDB6914 C825934D 8A1FC20B 486F14EA
  36D8536F 8D312F3D 6CBCA720 A311CC28 D5D86432 249392DC 19DC79CD BBA557EA
  08C21C5D 6DE5D0E5 828417B2 E56BA767 C6DD1220 1E7AE015 ABB8EFD4 0386FA04
  849EB165 FD06D670 68C6A08E 49E3A814 CD7267D5 140CCA4D C23A7676 249B8B73
  2A2F8550 0C466DFD BD855B05 99232D8F C077020E FC131BDF 58DB0150 1F653682
  CA7B8BDD C6F30203 010001A3 63306130 0F060355 1D130101 FF040530 030101FF
  300E0603 551D0F01 01FF0404 03020186 301F0603 551D2304 18301680 14898D10
  9B989422 A4FE365A 30E9748C 89F85168 51301D06 03551D0E 04160414 898D109B
  989422A4 FE365A30 E9748C89 F8516851 300D0609 2A864886 F70D0101 04050003
  82010100 CC6A378D BB1482E4 1A5C2580 7447D072 C02F00F3 2C5CC225 A200BA97
  53E26940 BA9963BA 7A2DDBB6 DBFE335C 6A49D003 5FBE6CD2 9D902284 6286CE28
  150F390D 6CEE3994 AF5FA171 91947024 6E514ADB DA5BC9BE B95046F9 55248FCD
  153FAFB8 68147911 2D4814F6 1BFFFA60 7C1C96D8 15E6A77A 7D68181D 5AF4DB72
  3B3E22C2 2BED9F40 F13CE120 F336C06C 6F9A5595 CB05A960 551FF031 946C94FA
  0CCF6CD4 AB85F01C 919E7282 8AB5B73C A1A54C9B BDC38903 76A96215 0678C5C4
  94AA2402 97D20660 DEBA15D0 4D0B61EA F64C96A6 4CBB92D3 FB351498 3C3B0EF0
  18A2CF0A B84267D6 EE2D0B01 CCF51190 C375BAB9 4038FE71 65F0BC9C A3F9D5FF 19D16F
14
        quit
!
redundancy
!
```
#### <a id=1> 1. Настроим GRE поверх IPSec между офисами Москва и С.-Петербург.</a>

**Конфигурация R14 (на R15, R18, R27, R28 выполнена аналогичная конфигурация):**
*Настроим crypto isakmp policy для 1 фазы ipsec и ipsec transform-set для второй фазы*

```
crypto isakmp policy 1
 encr aes 192
 hash sha256
 group 5
crypto ipsec transform-set IPSEC esp-aes esp-sha-hmac
 mode transport
crypto ipsec profile IPSEC_GRE_DMVPN
 set transform-set IPSEC
R14#
```
**Применим ipsec profile на туннельный интерфейс:**

```
R14#show running-config interface tunnel 0
Building configuration...

Current configuration : 171 bytes
!
interface Tunnel0
 ip address 10.10.1.14 255.255.255.0
 tunnel source 100.30.0.214
 tunnel destination 100.30.6.18
 tunnel protection ipsec profile IPSEC_GRE_DMVPN
end

R14#
```
Проверим поднялся ли GRE over IPsec туннель:

![gre over ipsec](https://github.com/MIranaNightshade/otus-networks/blob/main/lab14_ipsec/jpeg/GRE_over_IPsec.png)



